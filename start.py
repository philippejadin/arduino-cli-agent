#!/usr/bin/env python3

# this got me started quick https://stackoverflow.com/questions/33662842/simple-python-server-to-process-get-and-post-requests-with-json


from bottle import route, run, template, get, post, request, static_file
import subprocess
import sys
import os

DEBUG = True

def log(s):
    if DEBUG:
        print (s)
        print('-------------------')

@route('/hello/<name>')
def index(name):
    return template('<b>Hello {{name}}</b>!', name=name)


@route('/check')
def index():

    tmp = subprocess.run(["./arduino-cli", "compile", "--fqbn", "arduino:avr:uno", "/home/philippe/Sites/blocks/arduino-cli-agent/sketches/mysketcha"], stdout=subprocess.PIPE)
    print (tmp)
    return tmp.stdout

@route('/compile')
def index():
    return static_file('uploader.html', './examples/')

@post('/compile')
def index():
    if not request.forms.get('arduino_code') or not request.forms.get('board') or not request.forms.get('filename'):
        abort(500, "<H1>Error</H1> Please fill in the arduino_code, board and filename fields.")

    sketch_name = request.forms.get('filename')

    sketch_path =  os.getcwd() + '/sketches/' + sketch_name + '/'

    # Create the sketch directory and file
    try:
        os.makedirs (sketch_path)
    except:
        log('Error creating sketch directory at ' +  sketch_path)

    sketch_path =  os.getcwd() + '/sketches/' + sketch_name + '/'
    sketch_filename = sketch_path + sketch_name + '.ino'

    sketch_file = open(sketch_filename, 'w')
    sketch_file.write("// File autogenerated by blockly, save as a copy to avoid overwrite\n\n")
    sketch_file.write(request.forms.get('arduino_code'))
    sketch_file.close();


    log(type(request.forms.get('board')))
    command_line = ["./arduino-cli", "compile", "--fqbn", str(request.forms.get('board')), str(sketch_path)]
    log(command_line)
    compile_process = subprocess.run(command_line, stdout=subprocess.PIPE, cwd=os.path.dirname(os.path.abspath(__file__)))
    log (str(compile_process))
    return compile_process.stdout



if sys.version_info[0] < 3:
    raise Exception("Python 3 or a more recent version is required.")

run(host='localhost', port=3280, debug=True, reloader=True)
